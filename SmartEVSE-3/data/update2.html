<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SmartEVSEv3</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * { font-size:16; font-family: Arial; }
      #container { margin-right: auto; margin-left: auto; max-width: 900px; }
      #info { background: #e0f0f0; border-radius: .5em; padding: 2em;  }
      #wrapper { margin-top: 1em; }
    </style>
    <script>
        // Helper function to display upload status
        var setStatus = function(text) {
          document.getElementById('el3').innerText = text;
        };

    </script>
  </head>
  <body onload="loadData()">
    <div id="container">
      <div id="info">
          Current version: <span id="version"></span>
          <br><br><br>
          FLASHING
          <br><br>
          Flash one of:<ul>
              <li><b>firmware.bin</b>  - to update the firmware</li>
              <li><b>firmware.debug.bin</b> - if you want to telnet to your SmartEVSE to see debug messages</li>
              <li><b>rfid.txt</b>  - if you want to bulk upload allowed NFC tags for the RFID reader</li>
          </ul>
          You should only flash files with those exact names.<br>
      </div>
      <div id="wrapper">
        <input type="file" id="el1" style="display: none"/>
        <button id="el2">  Select file ...  </button>
        <div id="el3"></div>
      </div>
    </div>
  </body>

  <script type="module">
window.loadData=loadData;

function loadData() {
    document.getElementById("version").innerHTML = sessionStorage.getItem("version");
}

// When user clicks on a button, trigger file selection dialog
var button = document.getElementById('el2');
button.onclick = function(ev) {
  input.click();
};

// Send a large blob of data chunk by chunk
var sendFileData = function(name, data, chunkSize) {
  var sendChunk = function(offset) {
    var chunk = data.subarray(offset, offset + chunkSize) || '';
    var opts = {method: 'POST', body: chunk};
    var url = '/update?offset=' + offset + '&file=' + encodeURIComponent(name) + '&size=' + data.length;
    var ok;
    if (offset + chunk.length == data.length) {
        setStatus('Upload of ' + name + ' finished, will reboot. You can close this page.');
        window.location.href = "/";
    }
    else
        setStatus('Uploading ' + name + ', bytes ' + offset + '..' + (offset + chunk.length) + ' of ' + data.length);
    fetch(url, opts)
        .then(function(res) {
          if (res.ok && chunk.length > 0) sendChunk(offset + chunk.length);
          ok = res.ok;
          return res.text();
        })
        .then(function(text) {
          if (!ok) setStatus('Error: ' + text);
        });
  };
  sendChunk(0);
};

// If user selected a file, read it into memory and trigger sendFileData()
var input = document.getElementById('el1');
input.onchange = function(ev) {
  if (!ev.target.files[0]) return;
  var f = ev.target.files[0], r = new FileReader();
  r.readAsArrayBuffer(f);
  r.onload = function() {
    ev.target.value = '';
    sendFileData(f.name, new Uint8Array(r.result), 20480);
  };
};
    </script>
</html>
